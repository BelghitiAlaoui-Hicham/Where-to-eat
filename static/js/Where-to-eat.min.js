/*! Where-to-eat - v0.1.0 - 2014-02-08
* Copyright (c) 2014 ; Licensed  */
!function(a){"use strict";a.Cookie={},a.Cookie.createCookie=function(a,b,c){var d;if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toGMTString()}else d="";document.cookie=a+"="+b+d+"; path=/"},a.Cookie.readCookie=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b))return e.substring(b.length,e.length)}return null},a.Cookie.eraseCookie=function(b){a.Cookie.createCookie(b,"",-1)}}(window.Josh=window.Josh||{}),function(a,b){"use strict";var c;a.Socket=function(a){d(a)};var d=function(a){c=io.connect(a)};return a.Socket.prototype.addEvent=function(a,d){c.on(a,function(c){b(d).trigger(a,c)})},a.Socket.prototype.getVotes=function(){c.emit("getVotes")},a.Socket.prototype.getUsers=function(){c.emit("get")},a.Socket.prototype.addUser=function(a,b,d){c.emit("add",a,b,d)},a.Socket.prototype.addVote=function(a){var d=b.extend(!0,{},a);delete d.marker,delete d.user,c.emit("addVote",d)},a.Socket}(window.Josh=window.Josh||{},window.jQuery),function(a){"use strict";a.User=function(a,b){this.username=a,this.img=b,this.imgHTML='<img src="'+b+'" class="userimg" title="'+a+'">'}}(window.Josh=window.Josh||{}),function(a,b){"use strict";var c,d,e,f,g,h,i,j,k,l,m,n,o=function(){};a.Map=function(p){m=new a.Socket("http://ejosh.co:8080/users"),this.map=new L.Map(p,{zoomAnimation:!0});var q=new L.StamenTileLayer("toner-lite");this.map.addLayer(q),c=L.Icon.extend({options:{shadowUrl:null,iconSize:new L.Point(32,32)}}),d=document.getElementById("fsRest"),f=document.getElementById("acts"),e=document.getElementById("votes"),g=document.getElementById("loginArea"),h=document.getElementById("search"),i=b("#searchText"),j=document.getElementById("clear"),k=b("#title"),n=b("#alert");var r=this;navigator.geolocation.getCurrentPosition(function(a){r.centerLoc(a)},o,{timeout:1e4}),b(d).on("click","button",function(a){var c=b(a.target);if(null!==r.currentUser){var d=c.attr("data-fsid"),e=r.findFs(d);m.addVote(e)}else r.addAlert("You must be logged in!")}),b(e).on("click","li a",function(a){a.preventDefault(),r.showRest(b(a.target).attr("data-fsid"))}),b(f).on("click","li a",function(a){a.preventDefault(),r.showRest(b(a.target).attr("data-fsid"))}),b(g).on("focusout","input",function(a){var c=b(a.target).val();r.addUser(c)}),b(g).on("click","a",function(a){a.preventDefault(),r.removeUser()}),b(h).on("click",function(a){r.addAlert("Searching for Restaurants"),a.preventDefault(),r.findRests(i.val()),r.removeAlert()}),b(j).on("click",function(a){a.preventDefault(),i.val(""),r.addSearchLayer({})}),n.on("click",function(){r.removeAlert()}),this.searchFs={},this.voteFs=new a.Votes,this.currentUser=null,this.searchLayer=null,this.location=null,m.addEvent("vote",this),b(this).on("vote",function(b,c){if(void 0===this.voteFs.votes[c.fs.id]){var d=this.addMarker(c.fs);c.fs.marker=d}c.fs.user=[new a.User(c.username,c.img)],this.addActivity(c.fs.user[0],c.fs.name,c.fs.id),this.voteFs.addVote(c.fs),this.showVotes()}),b(this.voteFs).on("removeLayer",function(a,b){r.removeLayer(b)}),window.addEventListener("hashchange",function(){window.location.reload()}),window.location.hash?(l=String(window.location.hash).slice(1),k.html(l)):l="default";var s=a.Cookie.readCookie("username");null!==s&&this.addUser(s)},a.Map.prototype={centerLoc:function(a){this.location=a;var b=new L.LatLng(this.location.coords.latitude,this.location.coords.longitude);this.map.setView(b,13)},addMarker:function(a,b){b="undefined"!=typeof b?b:!0;var d;d=a.categories.length>0?new c({iconUrl:a.categories[0].icon.prefix+"bg_32"+a.categories[0].icon.suffix}):new L.Icon({iconUrl:"images/marker.png"});var e=new L.LatLng(a.location.lat,a.location.lng),f=new L.Marker(e,{icon:d,title:a.name});return f.fsid=a.id,f.img=d.iconUrl,f.on("click",this.showRestProxy.bind(this)),b&&this.map.addLayer(f),f},removeMarker:function(a){a.clearAllEventListeners()},removeLayer:function(a){if(void 0!==a.getLayers)for(var b=a.getLayers(),c=0;c<b.length;c++)this.removeMarker(b[c]);this.map.removeLayer(a)},addSearchLayer:function(a){null!==this.searchLayer&&this.removeLayer(this.searchLayer),this.searchLayer=new L.LayerGroup;for(var b in a){this.addSearchFs(a[b]);var c=this.addMarker(a[b],!1);this.searchLayer.addLayer(c)}this.map.addLayer(this.searchLayer)},showRestProxy:function(a){this.showRest(a.target.fsid)},showRest:function(a){var c,e=this.findFs(a);c=e.categories.length>0?e.categories[0].icon.prefix+"bg_32"+e.categories[0].icon.suffix:"images/marker.png";var f='<h3><img src="'+c+'">'+e.name+"</h3>";if(void 0!==e.phone&&(f+="<div>Phone: "+e.phone+"</div>"),void 0!==e.menu&&(f+='<div><a href="'+e.menu.url+'" target="_blank">Menu</a></div>'),void 0!==e.user){f+="<div>Votes: "+e.user.length+"</div>",f+="<div>";for(var g=0;g<e.user.length;g++)f+=e.user[g].imgHTML;f+="</div>"}f+='<button class="btn" data-fsid="'+e.id+'">Vote for Me</button>',b(d).html(f)},addSearchFs:function(a){this.searchFs[a.id]=a},removeSearchFs:function(){this.searchFs={}},findFs:function(a){return this.voteFs.votes[a]?this.voteFs.votes[a]:this.searchFs[a]},addUser:function(c){if(""!==c){var d,e=new RegExp("^(fb:)?"),f=c.split(e);f.length>1?(d=f[f.length-2],c=f[f.length-1]):d="gravatar";var h;if(d&&"fb:"===d)h=document.createElement("img"),h.setAttribute("src","https://graph.facebook.com/"+c+"/picture?type=square");else if(null!==a.Cookie.readCookie("img"))h=document.createElement("img"),h.setAttribute("src",a.Cookie.readCookie("img"));else{var i=md5(c.toLowerCase());h=document.createElement("img"),h.setAttribute("src","http://www.gravatar.com/avatar/"+i+"?d=retro&s=18")}this.currentUser=new a.User(c,h.src),m.addUser(String(c),String(h.src),l);var j=this.currentUser.imgHTML+c+' : <a href="#">Sign out</a>';b(g).html(j),a.Cookie.createCookie("username",c),a.Cookie.createCookie("img",h.src),m.getVotes()}},removeUser:function(){a.Cookie.eraseCookie("username"),a.Cookie.eraseCookie("img"),this.currentUser=null,b(g).html('<input id="login" type="text" placeholder="email">')},addActivity:function(a,c,d){var e="<li>"+a.imgHTML+a.username+' voted for <a href="#" data-fsid="'+d+'">'+c+"</li><hr/>";b(f).append(e)},showVotes:function(){var a=[];for(var c in this.voteFs.votes)a.push([this.voteFs.votes[c].name,this.voteFs.votes[c].user.length,this.voteFs.votes[c].id,this.voteFs.votes[c].user]);a.sort(function(a,b){return b[1]-a[1]});for(var d="",f=0;f<a.length;f++){d+="<li>"+a[f][1]+' for <a href="#" data-fsid="'+a[f][2]+'">'+a[f][0]+"</a></li>";for(var g=0;g<a[f][3].length;g++)d+=a[f][3][g].imgHTML}b(e).html(d)},findRests:function(a){var c="https://api.foursquare.com/v2/venues/search?ll="+this.location.coords.latitude+","+this.location.coords.longitude+"&client_id=NQNF2JL2VKJHXETAOND5TPJ23A2SWGZC4TXJEMLGJBXYMIJM&client_secret=TF1CC0HZVBJ0TM50CRNJNTWSOWZMIKQ30V4DEB4GC2UWZ3KM&v=20140128";c+=""!==a?"&query="+encodeURI(a):"&query="+encodeURI("restaurant");var d=this;b.getJSON(c,function(a){var b=a.response.venues;d.addSearchLayer(b)})},addAlert:function(a){n.removeClass("none"),n.html(a)},removeAlert:function(){n.addClass("none")}}}(window.Josh=window.Josh||{},window.jQuery),function(a,b){"use strict";a.Votes=function(){this.votes={}},a.Votes.prototype={addVote:function(a){var c=this.findByUser(a.user[0].username);if(void 0!==c)if(1===c.user.length)void 0===a.marker&&(a.marker=c.marker),a.id!==c.id&&b(this).trigger("removeLayer",c.marker);else for(var d=0;d<c.user.length;d++)c.user[d].username===a.user[0].username&&(this.votes[c.id]=c);var e=this.findByFs(a.id);void 0!==e?(e.user.push(a.user[0]),this.votes[e.id]=e):this.votes[a.id]=a},findByUser:function(a){for(var b in this.votes)for(var c=0;c<this.votes[b].user.length;c++)if(this.votes[b].user[c].username===a){var d=this.votes[b];return delete this.votes[b],d}},findByFs:function(a){var b=this.votes[a];return delete this.votes[a],b}}}(window.Josh=window.Josh||{},window.jQuery);