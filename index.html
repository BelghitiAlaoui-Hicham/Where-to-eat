<html>
<head>
	<title>Socket Test</title>
	<style>
	body {height:100%;}
	#wrapper { width: 960px; margin: 0 auto;}
	#left {width: 66%; float:left; margin-right: 10px;}
	#right {width: 33%; float:left; }
	#stuck {position: absolute; z-index: 1000; top: 0; right: 0;}
	.me {background: white;}
	</style>
	<link rel="stylesheet" href="leaflet.css" />
	<link rel="stylesheet" href="css/bootstrap.min.css" />
</head>
<body>
<div class="container">
<div id="stuck"></div>
<h1>Node Test</h1>
<div id="left">
	<div id="map" style="height: 400px"></div>
</div>
<div id="right">
	User:<input id="username" type="text" name="user" />
	<div id="usertest"></div>
	<div id="currentUsers" class="well">
	Currently Connected:
	<ul id="users">
	</ul>
	</div>
	Search:<input id="search" type="text" name="search" />
	<div id="fsRest" class="well"></div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="js/socket.io.js"></script>
<script src="js/geohash.js"></script>
<script src="js/md5.js"></script>
<!--<script src="js/OpenLayers.js"></script>-->
<script src="leaflet.js"></script>
<script>

var users = io.connect('http://192.168.1.89:8080/users');

users.on('users', function(d){
	console.log(d);
	usersul = $('#users');
	console.log(usersul.children('li[data-user="' + d.username + '"]').length);
	
	if(usersul.children('li[data-user="' + d.username + '"]' ).length == 0){
		if(d.me){lic = '<li class="me" ';}else{lic='<li ';}
		usersul.append( lic + 'data-user="' + d.username + '"><img src="' + d.img + '"/>' + d.username+'</li>');
	}else{
		if(d.me){
			usersul.children('li[data-user="' + d.username + '"]' ).addClass('me');
		}
	}
});

users.on('count', function(d){ $('#stuck').append(d.count+'#');});

users.emit('count');
users.emit('get');

function restUser(username, type){
	this.username = username;
	this.type;
	this.view = null;
	this.img = null;
	this.init = function(){
		this.setImg();
	}
	
	this.setImg = function(){
		var img;
		if(type == 'fb:')
		{
			img = document.createElement('img');
			img.setAttribute('src', 'https://graph.facebook.com/' + this.username + '/picture');
		}else{
			emailhash = md5(this.username.toLowerCase());
			img = document.createElement('img');
			img.setAttribute('src', 'http://www.gravatar.com/avatar/' + emailhash + '?d=mm');
		}
		this.img = img;
	}
	
	this.render = function(){
		if(this.view){
			return this.view;
		}else{
			wrapper = document.createElement('div');
			namediv = document.createElement('div');
			namediv.innerText = username;
			console.log(namediv);
			$(wrapper).append([namediv, this.img]);
			
			this.view = wrapper;
			return wrapper;
		}
	};
	
	this.init();
}

$("#username").on("focusout", function(e){
	username = $(this).val();
	console.log(username);
	var re = new RegExp("^(fb:)?");
	var usersplit = username.split(re);
	console.log(usersplit);
	if(usersplit.length > 1)
	{
		//we have a match
		//grab the end piece
		usertype = usersplit[usersplit.length-2];
		fbuser = usersplit[usersplit.length-1];
		console.log(usertype);
		console.log(fbuser);
		var user = new restUser(fbuser, usertype);
		console.log(user.render());
		//$("#usertest").html(user.render());
		
	}else{
		user = new restUser(username);
		//$("#usertest").html(user.render());
	}
	testu = String(user.username);
	testi = String(user.img.src);
	users.emit('add', testu, testi);
});

//navigator.geolocation.getCurrentPosition(function(location){locSuccess(location)},locError,{timeout:10000});

//fake gelocation point
var locationTest = {
		coords: {
			longitude: -86.2423926,
			latitude: 41.6465882
		}
}

var locSuccess = function(location){
	console.log(location);
	var hull = new L.LatLng(location.coords.latitude, location.coords.longitude);
	map.setView(hull,11);
};


var locError = function(error){};

var map;

map = new L.Map('map');
var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osmAttrib='Map data © openstreetmap contributors';
var osm = new L.TileLayer(osmUrl,{minZoom:8,maxZoom:18,attribution:osmAttrib});


map.addLayer(osm);


//fake call to use the point
locSuccess(locationTest);

var eats = {};

$('#search').on('focusout', function(e){getRests($(this).val())});

function getRests(query){
	//url = 'http://192.168.1.89/aaron/nodetest/fs.php?callback=?&ll=' + locationTest.coords.latitude + ',' + locationTest.coords.longitude;
	url = 'http://localhost/test/fs.php?&ll=' + locationTest.coords.latitude + ',' + locationTest.coords.longitude;
	if(query != ''){
		url += '&query=' + encodeURI(query) ;
	}
$.getJSON( url , 
function(data){
	eats = {};
	console.log(data);
	rests = data.response.groups[0].items;
	if(window.searchl){
		map.removeLayer(window.searchl);
	}
	window.searchl = new L.LayerGroup();
	for(id in rests )
	{
		if(rests[id].categories.length > 0)
		{
		var restIcon = L.Icon.extend({
		    iconUrl: rests[id].categories[0].icon,
		    shadowUrl: null,
		    iconSize: new L.Point(32, 32)
		});
		}else{
			var restIcon = L.Icon.extend({
			    iconUrl: 'images/marker.png',
			});
		}
		
		var markerLocation = new L.LatLng(rests[id].location.lat, rests[id].location.lng);

		var marker = new L.Marker(markerLocation, {icon: new restIcon(), title: rests[id].name});
		//marker.bindPopup('<button class="mapVote btn" data-fsid="' + rests[id].id + '" onclick="test()"><i class="icon-ok"></i>' + rests[id].name + '</button>');
		butt = document.createElement('button');
		butt.innerHTML='<i class="icon-ok"></i>' + rests[id].name;
		butt.setAttribute('data-fsid', rests[id].id);
		//$(butt).on('click', function(e){fsTest(e);});
		table = '<table><tr><td>Name</td><td>' + rests[id].name + '</td></tr><tr><td>Phone</td><td>' + rests[id].contact.formattedPhone + '</td></tr></table>';
		//marker.bindPopup(table);
		marker.fsid = rests[id].id;
		marker.location = rests[id].location;
		marker.name = rests[id].name;
		eats[rests[id].id] = rests[id];
		console.log(eats);
		marker.on('click', function(e){ fsTest(e);});
		window.searchl.addLayer(marker);
		//$('#fslist').append('<li id="fs' + rests[id].id +'" ><button class="btn">Vote</button>' + rests[id].name + '</li>');
	}
	map.addLayer(window.searchl);
	$('button').on('click', function(e){console.log(e);});

});
}

var fsTest = function(e){
	showRest(e.target.fsid);
};

var showRest = function(fsid){
	rest = eats[fsid];
	table = '<h3>' + rest.name + '</h3><table><tr><td>Phone</td><td>' + rest.contact.formattedPhone + '</td></tr><tr><td>Menu</td><td><a href="' + rest.menu.url + '" target="_blank">Menu</a></td></tr></table>';
	butt = document.createElement('button');
	butt.innerHTML='<i class="icon-ok"></i> Sign me up';
	butt.setAttribute('data-fsid', rests[id].id);
	$('#fsRest').html(table);
	$('#fsRest').append(butt);
	$(butt).on('click', function(e){collectVote(rest);});
}

var collectVote = function(rest){
	console.log(rest);
	users.emit('vote', rest);
};

var votes = [];

function test(e){console.log(e)};

//$('#map').on('click', function(e){console.log(e);});


</script>
<script>
  /*var socket = io.connect('http://192.168.1.89:8080');
  socket.on('news', function (data) {
    console.log(data);
    socket.emit('my other event', { my: 'data' });
  });*/
</script>
</div>
</body>
</html>