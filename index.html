<html>
<head>
	<title>Socket Test</title>
	<style>
	body {height:100%;}
	#wrapper { width: 960px; margin: 0 auto;}
	#left {width: 66%; float:left; margin-right: 10px;}
	#right {width: 33%; float:left; }
	#stuck {position: absolute; z-index: 1000; top: 0; right: 0;}
	.me {background: white;}
	</style>
	<link rel="stylesheet" href="leaflet.css" />
	<link rel="stylesheet" href="css/bootstrap.min.css" />
</head>
<body>
<div class="container">

<div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="brand" href="#">Node Test</a>
      
      <ul class="nav  pull-right">
      
      	<li class="dropdown">
		  
		    <a href="#"
		          class="dropdown-toggle"
		          data-toggle="dropdown">
		          Connected
		          <b class="caret"></b>
		    </a>
		    <ul class="dropdown-menu span4" id="users">
		    </ul>
		  </li>
      
      	<li class="divider-vertical"></li>
		  <li class="dropdown">
		  
		    <a href="#"
		          class="dropdown-toggle"
		          data-toggle="dropdown">
		          <span id="me">Log in</span>
		          <b class="caret"></b>
		    </a>
		    <ul class="dropdown-menu">
		    <li><form class="form-inline">
		  <input id="username" type="text" class="input-small" name="user" />
		  <button class="btn" id="signin">Sign in</button>
		  </form></li>
		  <li><a id="signout" href="#">Sign out</a></li>
		    </ul>
		  </li>
		</ul>
    </div>
  </div>
</div>

<div id="stuck"></div>

<div id="left">
	<div id="map" style="height: 400px"></div>
</div>
<div id="right">
	
	<div class="well">
		<form class="form-search">
  			<input type="text" id="search" class="input-medium search-query">
  			<button type="submit" class="btn">Search</button>
		</form>
		<div id="fsRest"></div>
	</div>
	<div  class="well">
		<ul id="votes">
		</ul>
	</div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="js/socket.io.js"></script>
<script src="js/geohash.js"></script>
<script src="js/md5.js"></script>
<!--<script src="js/OpenLayers.js"></script>-->
<script src="leaflet.js"></script>
<script src="js/bootstrap-dropdown.js"></script>
<script>
function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}

function eraseCookie(name) {
	createCookie(name,"",-1);
}

$('.dropdown-toggle').dropdown();

(function(Josh, $){
	var sock;
	var url;
	
	Josh.Socket = function(url){
		init(url);
	};
	
	var init = function(url){
		sock = io.connect(url);
	};
	
	Josh.Socket.prototype.addEvent = function(name, obj){
		sock.on(name, function(d){ 
			$(obj).trigger(name, d);
			});
	};
	
	Josh.Socket.prototype.getVotes = function(){
		sock.emit('getVotes');
	};
	
	Josh.Socket.prototype.getUsers = function(){
		sock.emit('get');
	};
	
	Josh.Socket.prototype.addUser = function(username, img){
		sock.emit('add', username, img);
	};
	
	Josh.Socket.prototype.addVote = function(fs){
		sock.emit('vote', fs);
	}
	
	return Josh.Socket;
})(window.Josh = window.Josh || {},  window.jQuery);

(function(Josh, $){
	Josh.User = function(username, img){
		this.username = username;
		this.img = img;
	};
})(window.Josh = window.Josh || {},  window.jQuery);

(function(Josh, $){
	var id;
	var map;
	var osm;
	var searchLayer;
	var restIcon;
	var markerDiv;
	
	Josh.Map = function(id){
		id = id;
		map = new L.Map(id);
		osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
		osmAttrib='Map data © openstreetmap contributors';
		osm = new L.TileLayer(osmUrl,{minZoom:8,maxZoom:18,attribution:osmAttrib});
		
		map.addLayer(osm);
		
		restIcon = L.Icon.extend({
		    shadowUrl: null,
		    iconSize: new L.Point(32, 32)
		});
		
		markerDiv = document.getElementById('fsRest');
		This = this;
		$(markerDiv).on('click', 'button', function(e){
			target = $(e.target);
			fsid = target.attr('data-fsid');
			vt.addVote(This.findFs(fsid));
			console.log(This.findFs(fsid));
		});
		
		this.searchFs = {};
		this.voteFs = {};
	};
	
	var shortFs = function(fs){
		var  phone, menu, img;
		
		if(typeof fs.contact.formattedPhone !== 'undefined'){
			phone = fs.contact.formattedPhone;
		}
		
		if(typeof fs.menu !== 'undefined'){
			menu = fs.menu.url;
		}
		
		if(fs.categories.length > 0){
			img = fs.categories[0].icon;
		}else{
			img = 'images/marker.png';
		}
		
		distance = fs.location.distance * .00062;
		
		delete fs;
		return {id: fs.id, name: fs.name, phone: phone, menu: menu, img: img, distance: distance};
		
	};
	
	Josh.Map.prototype = {
		centerLoc: function(location){
			var hull = new L.LatLng(location.coords.latitude, location.coords.longitude);
			map.setView(hull, 11);
		},
		
		addMarker: function(fs, layeradd){
			layeradd = typeof layeradd !== 'undefined' ? layeradd : true;
			
			var icon;
			if(fs.categories.length > 0){
				icon = new restIcon( fs.categories[0].icon);
			}else{
				icon = new L.Icon('images/marker.png');
			}
			
			var markerLocation = new L.LatLng(fs.location.lat, fs.location.lng);
			var marker = new L.Marker(markerLocation, {icon: icon, title: fs.name});
			marker.fs = shortFs(fs);
			var This = this;
			marker.on('click', function(e){ This.showRest(e.target);});
			if(layeradd){
				map.addLayer(marker);
			}
			
			return marker;
		},
		
		removeLayer: function(arg){
			map.removeLayer(arg);
		},
		
		addSearchLayer: function(rests){
			if(searchLayer != undefined){
				//remove all the current restaurants
				map.removeLayer(searchLayer);
			}
			searchLayer = new L.LayerGroup();
			
			for(id in rests){
				this.addSearchFs(rests[id]);
				marker = this.addMarker(rests[id], false);
				eats[rests[id].id] = rests[id];
				searchLayer.addLayer(marker);
			}
			
			map.addLayer(searchLayer);
			
		},
		
		showRest: function(target){
			fs = target.fs;
			htmld = '<h3><img src="' + fs.img + '">' + fs.name + '</h3>';
			
			if(fs.phone != undefined)
				htmld += '<div>Phone: ' + fs.phone + '</div>';
			
			if(fs.menu != undefined)
				htmld += '<div><a href="' + fs.menu + '" target="_blank">Menu</a></div>';
			
			htmld += '<div>Distance: ' + fs.distance + '</div>';
			htmld += '<button class="btn" data-fsid="' + fs.id + '">Vote for Me</button>';
			$(markerDiv).html(htmld);
		},
		
		addVoteFs: function(fs){
			this.voteFs[fs.id] = fs;
			console.log(this);
		},
		
		removeVoteFs: function(fs){
			delete this.voteFs[fs.id];
		},
		
		addSearchFs: function(fs){
			this.searchFs[fs.id] = fs;
		},
		
		removeSearchFs: function(fs){
			//this is removed as a group
			this.searchFs = {};
		},
		
		findFs: function(fsid){
			if(this.searchFs[fsid]){
				return this.searchFs[fsid];
			}else{
				return this.voteFs[fsid];
			}
		},
	};
	
})(window.Josh = window.Josh || {},  window.jQuery);


(function(Josh, $){
	Josh.Votes = function(){
		var votes = {};
		
		this.votes = votes;
		$(this).on('vote', function(e, d){
			marker = map.addMarker(d.fs);
			map.addVoteFs(d.fs);
			this.addVote({user: [new Josh.User(d.username, d.img)], marker: marker, fsid: d.fs.id});
		});
		
	};
	
	Josh.Votes.prototype = {
		addVote: function(vote){
			//first check to see if this person has voted already
			userVote = this.findByUser(vote.user[0].username);
			if(userVote != undefined){
				 //this person voted, now check to see if this is the only vote
				 if(userVote.user.length == 1){
					 //only this person voted for this restaurant delete it
					 //but first take the marker off the map
					 map.removeLayer(userVote.marker);
					 delete userVote;
				 }else{
					 //multiple people voted for it, just remove their vote
					 for(var i=0; i < userVote.user.length; i++){
						 if(userVote.user[i].username == vote.user[0].username){
							 //we found it! Remove only this user
							 prevVote = userVote.user.splice(i, 1);
							 delete prevVote;
							 //put the vote back in
							 this.votes[userVote.fsid] = userVote;
						 }
					 }
				 }
			}
			
			//now check to see if the restaurant exists
			restVote = this.findByFs(vote.fsid);
			if(restVote != undefined){
				//add the user to the user list
				restVote.user.push(vote.user[0]);
				//put the vote back in
				this.votes[restVote.fsid] = restVote;
			}else{
				//nothing else is true
				//add it to the object
				this.votes[vote.fsid] = vote;
			}
			
		},
		
		findByUser: function(username){
			for(var i in this.votes){
				for(var u=0; u < this.votes[i].user.length; u++){
					if(this.votes[i].user[u].username == username){
						retEl = this.votes[i];
						delete this.votes[i];
						return retEl;
					}
				}
			}
		},
		
		findByFs: function(fsid){
			retEl = this.votes[fsid];
			delete this.votes[fsid];
			return retEl;
		},
		
		addEvent: function(name){
			
		}
	};
})(window.Josh = window.Josh || {},  window.jQuery);

socket = new Josh.Socket('http://192.168.1.89:8080/users');
//console.log(socket);

socket.getVotes();

vt = new Josh.Votes();

socket.addEvent('vote', vt);
//$(vt).on('vote', function(e, d){ console.log(d);});

$(document).on('vote', function(e, d){console.log('This was a custom trigger that received this data'); });

 users = io.connect('http://192.168.1.89:8080/users');

 
myusername = readCookie('username');
if(myusername != null){
	//users.emit('add', myusername, readCookie('img'));
	socket.addUser(myusername, readCookie('img'));
}


users.on('users', function(d){
	console.log(d);
	myusername = readCookie('username');
	if(myusername == d.username){
		d.me = true;
	}
	usersul = $('#users');
	console.log(usersul.children('li[data-user="' + d.username + '"]').length);
	if(d.me){
		$('#me').html('<img src="' + d.img + '"/>' + d.username);
		return;
	}
	if(usersul.children('li[data-user="' + d.username + '"]' ).length == 0){
		if(d.me){lic = '<li class="me" ';}else{lic='<li ';}
		usersul.append( lic + 'data-user="' + d.username + '"><img src="' + d.img + '"/>' + d.username+'</li>');
	}else{
		if(d.me){
			usersul.children('li[data-user="' + d.username + '"]' ).addClass('me');
		}
	}
});

users.on('count', function(d){ $('#stuck').append(d.count+'#');});
$(document).on('vote', function(e, d){
//users.on('vote', function(d){
	//console.log(e);
	//console.log(d);
	$('#votes').append('<li>' + d.username + ' voted for ' + d.fs.name + '</li>');
	var restIcon = L.Icon.extend({
	    iconUrl: d.fs.categories[0].icon,
	    shadowUrl: null,
	    iconSize: new L.Point(32, 32)
	});
	var markerLocation = new L.LatLng(d.fs.location.lat, d.fs.location.lng);

	var marker = new L.Marker(markerLocation, {icon: new restIcon(), title: d.fs.name});
	map.addLayer(marker);
	vt.addVote({user: [new Josh.User(d.username, d.img)], marker: marker, fsid: d.fs.id}); 
	//console.log(vt.findByUser('josh359@gmail.com'));
	//console.log(vt.findByFs("4ba541f0f964a520a1f238e3"));
	console.log(vt);
	
});

//users.emit('getVotes');
users.emit('count');
//users.emit('get');
socket.getUsers();

function restUser(username, type){
	this.username = username;
	this.type;
	this.view = null;
	this.img = null;
	this.init = function(){
		this.setImg();
	}
	
	this.setImg = function(){
		var img;
		if(type == 'fb:')
		{
			img = document.createElement('img');
			img.setAttribute('src', 'https://graph.facebook.com/' + this.username + '/picture?type=square');
		}else{
			emailhash = md5(this.username.toLowerCase());
			img = document.createElement('img');
			img.setAttribute('src', 'http://www.gravatar.com/avatar/' + emailhash + '?d=mm&s=18');
		}
		this.img = img;
	}
	
	this.render = function(){
		if(this.view){
			return this.view;
		}else{
			wrapper = document.createElement('div');
			namediv = document.createElement('div');
			namediv.innerText = username;
			console.log(namediv);
			$(wrapper).append([namediv, this.img]);
			
			this.view = wrapper;
			return wrapper;
		}
	};
	
	this.init();
}
$('#signout').on('click', function(e){ eraseCookie('username');});

$("#signin").on("click", function(e){
	e.preventDefault();
	username = $(this).siblings('input').val();
	console.log(username);
	var re = new RegExp("^(fb:)?");
	var usersplit = username.split(re);
	console.log(usersplit);
	if(usersplit.length > 1)
	{
		//we have a match
		//grab the end piece
		usertype = usersplit[usersplit.length-2];
		fbuser = usersplit[usersplit.length-1];
		console.log(usertype);
		console.log(fbuser);
		var user = new restUser(fbuser, usertype);
		console.log(user.render());
		//$("#usertest").html(user.render());
		
	}else{
		user = new restUser(username);
		//$("#usertest").html(user.render());
	}
	testu = String(user.username);
	testi = String(user.img.src);
	//users.emit('add', testu, testi);
	socket.addUser(testu, testi);
	document.cookie = 'username=' + user.username;
	document.cookie = 'img=' + user.img.src;
});

//navigator.geolocation.getCurrentPosition(function(location){locSuccess(location)},locError,{timeout:10000});

//fake gelocation point
var locationTest = {
		coords: {
			longitude: -86.2423926,
			latitude: 41.6465882
		}
}

var locSuccess = function(location){
	console.log(location);
	map.centerLoc(location);
};


var locError = function(error){};

var map;

map = new Josh.Map('map');

//fake call to use the point
locSuccess(locationTest);

var eats = {};

$('#search').on('focusout', function(e){getRests($(this).val())});

function getRests(query){
	//url = 'http://192.168.1.89/aaron/nodetest/fs.php?callback=?&ll=' + locationTest.coords.latitude + ',' + locationTest.coords.longitude;
	url = 'http://localhost:85/test/fs.php?&ll=' + locationTest.coords.latitude + ',' + locationTest.coords.longitude;
	if(query != ''){
		url += '&query=' + encodeURI(query) ;
	}
$.getJSON( url , 
function(data){
	eats = {};
	//console.log(data);
	rests = data.response.groups[0].items;
	map.addSearchLayer(rests);
});
}

var fsTest = function(e){
	showRest(e.target.fsid);
	
};

var showRest = function(fsid){
	rest = eats[fsid];
	table = '<h3>' + rest.name + '</h3><table><tr><td>Phone</td><td>' + rest.contact.formattedPhone + '</td></tr></table>';
	butt = document.createElement('button');
	butt.innerHTML='<i class="icon-ok"></i> Sign me up';
	butt.setAttribute('data-fsid', fsid);
	$('#fsRest').html(table);
	$('#fsRest').append(butt);
	$(butt).on('click', function(e){collectVote(rest);});
}

var collectVote = function(rest){
	console.log(rest);
	users.emit('vote', rest);
};

var votes = [];

function test(e){console.log(e)};

//$('#map').on('click', function(e){console.log(e);});


</script>
</div>
</body>
</html>