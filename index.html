<html>
<head>
	<title>Socket Test</title>
	<style>
	#wrapper { width: 960px; margin: 0 auto;}
	#left {width: 66%; float:left; margin-right: 10px;}
	#right {width: 33%; float:left; }
	</style>
	<link rel="stylesheet" href="leaflet.css" />
	<link rel="stylesheet" href="css/bootstrap.min.css" />
</head>
<body>
<div class="container">
<h1>Node Test</h1>
<div id="left">
	<div id="map" style="height: 400px"></div>
</div>
<div id="right">
	User:<input id="username" type="text" name="user" />
	<div id="usertest"></div>
	<ul id="fslist" class="well"></ul>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="js/socket.io.js"></script>
<script src="js/geohash.js"></script>
<script src="js/md5.js"></script>
<!--<script src="js/OpenLayers.js"></script>-->
<script src="leaflet.js"></script>
<script>
function restUser(username, type){
	this.username = username;
	this.type;
	this.view = null;
	this.img = null;
	this.init = function(){
		this.setImg();
	}
	
	this.setImg = function(){
		var img;
		if(type == 'fb:')
		{
			img = document.createElement('img');
			img.setAttribute('src', 'https://graph.facebook.com/' + this.username + '/picture');
		}else{
			emailhash = md5(this.username.toLowerCase());
			img = document.createElement('img');
			img.setAttribute('src', 'http://www.gravatar.com/avatar/' + emailhash + '?d=mm');
		}
		this.img = img;
	}
	
	this.render = function(){
		if(this.view){
			return this.view;
		}else{
			wrapper = document.createElement('div');
			namediv = document.createElement('div');
			namediv.innerText = username;
			console.log(namediv);
			$(wrapper).append([namediv, this.img]);
			
			this.view = wrapper;
			return wrapper;
		}
	};
	
	this.init();
}

$("#username").on("focusout", function(e){
	username = $(this).val();
	console.log(username);
	var re = new RegExp("^(fb:)?");
	var usersplit = username.split(re);
	console.log(usersplit);
	if(usersplit.length > 1)
	{
		//we have a match
		//grab the end piece
		usertype = usersplit[usersplit.length-2];
		fbuser = usersplit[usersplit.length-1];
		console.log(usertype);
		console.log(fbuser);
		var user = new restUser(fbuser, usertype);
		console.log(user.render());
		$("#usertest").html(user.render());
		
	}else{
		user = new restUser(username);
		$("#usertest").html(user.render());
	}
});

//navigator.geolocation.getCurrentPosition(function(location){locSuccess(location)},locError,{timeout:10000});

//fake gelocation point
var locationTest = {
		coords: {
			longitude: -86.2423926,
			latitude: 41.6465882
		}
}

var locSuccess = function(location){
	console.log(location);
	var hull = new L.LatLng(location.coords.latitude, location.coords.longitude);
	map.setView(hull,11);
};


var locError = function(error){};

var map;

map = new L.Map('map');
var osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
var osmAttrib='Map data © openstreetmap contributors';
var osm = new L.TileLayer(osmUrl,{minZoom:8,maxZoom:18,attribution:osmAttrib});


map.addLayer(osm);


//fake call to use the point
locSuccess(locationTest);



//foursquare stuff

fsConfig = {
	apiKey: 'NQNF2JL2VKJHXETAOND5TPJ23A2SWGZC4TXJEMLGJBXYMIJM',
	apiSecret: 'TF1CC0HZVBJ0TM50CRNJNTWSOWZMIKQ30V4DEB4GC2UWZ3KM',
	apiUrl: 'https://api.foursquare.com/'
};

var eats = {};

$.getJSON(fsConfig.apiUrl + 'v2/venues/search?ll=' + locationTest.coords.latitude + ',' + locationTest.coords.longitude + '&client_id=' + fsConfig.apiKey + '&client_secret=' + fsConfig.apiSecret + '&query=restaurant&limit=50' , 
function(data){
	console.log(data);
	rests = data.response.groups[0].items;
	for(id in rests )
	{
		if(rests[id].categories.length > 0)
		{
		var restIcon = L.Icon.extend({
		    iconUrl: rests[id].categories[0].icon,
		    shadowUrl: null,
		    iconSize: new L.Point(32, 32)
		});
		}else{
			var restIcon = L.Icon.extend({
			    iconUrl: 'images/marker.png',
			});
		}
		
		var markerLocation = new L.LatLng(rests[id].location.lat, rests[id].location.lng);

		var marker = new L.Marker(markerLocation, {icon: new restIcon(), title: rests[id].name});
		marker.bindPopup(rests[id].name + '<button class="mapVote" data-fsid="' + rests[id].id + '">Vote</button>');
		marker.fsid = rests[id].id;
		marker.location = rests[id].location;
		marker.name = rests[id].name;
		eats[rests[id].id] = rests[id];
		console.log(eats);
		marker.on('click', function(e){console.log(e.target); fsTest(e.target.fsid);});
		map.addLayer(marker);
		$('#fslist').append('<li id="fs' + rests[id].id +'" ><button class="btn">Vote</button>' + rests[id].name + '</li>');
	}
	

});

var fsTest = function(fsid){
	console.log($('#fs' + fsid));
};


var collectVote = function(fsobject){
	votes.push(fsobject);
};

var votes = [];



</script>
<script>
  /*var socket = io.connect('http://192.168.1.89:8080');
  socket.on('news', function (data) {
    console.log(data);
    socket.emit('my other event', { my: 'data' });
  });*/
</script>
</div>
</body>
</html>