<html>
<head>
	<title>Socket Test</title>
	<style>
	body {height:100%;}
	#wrapper { width: 960px; margin: 0 auto;}
	#left {width: 66%; float:left; margin-right: 10px;}
	#right {float:left; width: 30%}
	#stuck {position: absolute; z-index: 1000; top: 0; right: 0;}
	ul#votes li, ul#acts li {list-style: none;}
	#restaurant {height: 178px; overflow: auto;}
	.activity {height: 320px; overflow: auto;}
	.userimg {height: 18px; width: 18px;}
	</style>
	<link rel="stylesheet" href="leaflet.css" />
	<link rel="stylesheet" href="css/bootstrap.min.css" />
</head>
<body>
<div class="container">
<h1>Node Test</h1>

<div id="stuck"></div>

<div id="left">
	<div id="map" style="height: 620px"></div>
</div>
<div id="right">
	<div id="loginArea"><input id="login" type="text" placeholder="email"></div>
	<div id="restaurant" class="well">
		<form class="form-search">
  			<input type="text"  class="input-medium search-query" placeholder="search or leave blank">
  			<button type="submit"  id="search" class="btn">Search</button>
		</form>
		<div id="fsRest"></div>
	</div>
	<div id="tabs" class="tabbable">
		<ul class="nav nav-tabs">
			<li class="active"><a href="#tab1" data-toggle="tab">Votes</a></li>
    		<li><a href="#tab2" data-toggle="tab">Activity</a></li>
		</ul>
		<div class="tab-content">
		    <div class="tab-pane active activity" id="tab1">
		      <ul id="votes"></ul>
		    </div>
		    <div class="tab-pane activity" id="tab2">
		      <ul id="acts"></ul>
		    </div>
		  </div>
		
	</div>
</div>

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" type="text/javascript"></script>
<script src="js/socket.io.js"></script>
<script src="js/geohash.js"></script>
<script src="js/md5.js"></script>
<!--<script src="js/OpenLayers.js"></script>-->
<script src="leaflet.js"></script>
<script src="js/bootstrap-tab.js"></script>
<script>
function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}

function eraseCookie(name) {
	createCookie(name,"",-1);
}

$('#mtabs a').click(function (e) {
	  e.preventDefault();
	  $(this).tab('show');
	});

(function(Josh, $){
	var sock;
	var url;
	
	Josh.Socket = function(url){
		init(url);
	};
	
	var init = function(url){
		sock = io.connect(url);
		//test remove from prod
		sock.on('test', function(d){
			console.log(d);
		});
	};
	
	Josh.Socket.prototype.addEvent = function(name, obj){
		sock.on(name, function(d){ 
			$(obj).trigger(name, d);
			});
	};
	
	Josh.Socket.prototype.getVotes = function(){
		sock.emit('getVotes');
	};
	
	Josh.Socket.prototype.getUsers = function(){
		sock.emit('get');
	};
	
	Josh.Socket.prototype.addUser = function(username, img, area){
		console.log(username + ' ' + img);
		sock.emit('add', username, img, area);
	};
	
	Josh.Socket.prototype.addVote = function(fs){
		var fsSend = $.extend(true, {}, fs);
		delete fsSend.marker, fsSend.user;
		sock.emit('addVote', fsSend);
		delete fsSend;
	}
	
	return Josh.Socket;
})(window.Josh = window.Josh || {},  window.jQuery);

(function(Josh, $){
	Josh.User = function(username, img){
		this.username = username;
		this.img = img;
		this.imgHTML = '<img src="' + img + '" class="userimg" title="' + username + '">';
	};
})(window.Josh = window.Josh || {},  window.jQuery);

(function(Josh, $){
	var id;
	var map;
	var osm;
	var searchLayer;
	var restIcon;
	var markerDiv;
	var votesUl;
	var actsUl;
	var loginDiv;
	var search;
	var area;
	var location;
	var socket;
	
	Josh.Map = function(id){
		id = id;
		socket = new Josh.Socket('http://192.168.1.89:8080/users');
		map = new L.Map(id);
		console.log(map);
		osmUrl='http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
		osmAttrib='Map data © openstreetmap contributors';
		osm = new L.TileLayer(osmUrl,{minZoom:8,maxZoom:18,attribution:osmAttrib});
		
		
		map.addLayer(osm);
		
		restIcon = L.Icon.extend({
		    shadowUrl: null,
		    iconSize: new L.Point(32, 32)
		});
		
		
		markerDiv = document.getElementById('fsRest');
		actsUl = document.getElementById('acts');
		votesUl = document.getElementById('votes');
		loginDiv = document.getElementById('loginArea');
		search = document.getElementById('search');
		
		This = this;
		
		navigator.geolocation.getCurrentPosition(function(location){This.centerLoc(location)},locError,{timeout:10000});
		
		$(markerDiv).on('click', 'button', function(e){
			var target = $(e.target);
				if(This.currentUser != null){
				var fsid = target.attr('data-fsid');
				var fs = This.findFs(fsid);
				socket.addVote(fs);
				console.log(This.findFs(fsid));
			}else{
				alert('you must be logged in!');
			}
		});
		
		$(votesUl).on('click', 'li a', function(e){
			e.preventDefault();
			This.showRest($(e.target).attr('data-fsid'));
		});
		
		$(actsUl).on('click', 'li a', function(e){
			e.preventDefault();
			This.showRest($(e.target).attr('data-fsid'));
		});
		
		$(loginDiv).on('focusout', 'input', function(e){
			var username = $(e.target).val();
			This.addUser(username);
		});
		
		$(loginDiv).on('click', 'a', function(e){
			e.preventDefault();
			This.removeUser();
		});
		
		$(search).on('click', function(e){
			e.preventDefault();
			target = $(e.target);
			This.findRests(target.siblings('input').val());
		});
		
		this.searchFs = {};
		this.voteFs = new Josh.Votes();
		this.currentUser = null;
		
		socket.addEvent('vote', this);
		
		$(this).on('vote', function(e, d){
			
			console.log(this);
			//first check to see if it exists in the vote db
			if(this.voteFs.votes[d.fs.id] == undefined){
				marker = this.addMarker(d.fs);
				d.fs.marker = marker;
			}
			d.fs.user = [new Josh.User(d.username, d.img)];
			this.addActivity(d.fs.user[0], d.fs.name, d.fs.id);
			this.voteFs.addVote(d.fs);
			this.showVotes();
			console.log(d);
		});
		
		$(this.voteFs).on('removeLayer', function(e,d){
			This.removeLayer(d);
		});
		
		//listen for a hash change
		window.addEventListener("hashchange", function(){window.location.reload();});
		//see if we have a hash area
		if(window.location.hash) {
			area = String(window.location.hash).slice(1);
		} else {
		  //set to default
		  area = 'default';
		}
		
		//check the cookies for a current user
		myusername = readCookie('username');
		if(myusername != null){
			this.addUser(myusername);
		}
		
	};
	
	Josh.Map.prototype = {
		centerLoc: function(loc){
			location = loc;
			var hull = new L.LatLng(location.coords.latitude, location.coords.longitude);
			map.setView(hull, 11);
		},
		
		addMarker: function(fs, layeradd){
			layeradd = typeof layeradd !== 'undefined' ? layeradd : true;
			
			var icon;
			if(fs.categories.length > 0){
				icon = new restIcon( fs.categories[0].icon);
			}else{
				icon = new L.Icon('images/marker.png');
			}
			
			var markerLocation = new L.LatLng(fs.location.lat, fs.location.lng);
			var marker = new L.Marker(markerLocation, {icon: icon, title: fs.name});
			marker.fsid = fs.id;
			marker.img = icon.iconUrl;
			var This = this;
			marker.on('click', function(e){ This.showRest(e.target.fsid);});
			if(layeradd){
				map.addLayer(marker);
			}
			
			return marker;
		},
		
		removeLayer: function(arg){
			map.removeLayer(arg);
		},
		
		addSearchLayer: function(rests){
			if(searchLayer != undefined){
				//remove all the current restaurants
				map.removeLayer(searchLayer);
			}
			searchLayer = new L.LayerGroup();
			
			for(id in rests){
				this.addSearchFs(rests[id]);
				var marker = this.addMarker(rests[id], false);
				searchLayer.addLayer(marker);
			}
			
			map.addLayer(searchLayer);
			
		},
		
		showRest: function(fsid){
			var fs = this.findFs(fsid);
			
			var img;
			if(fs.categories.length > 0){
				img = fs.categories[0].icon;
			}else{
				img = 'images/marker.png';
			}
			
			htmld = '<h3><img src="' + img + '">' + fs.name + '</h3>';
			
			if(fs.phone != undefined)
				htmld += '<div>Phone: ' + fs.phone + '</div>';
			
			if(fs.menu != undefined)
				htmld += '<div><a href="' + fs.menu.url + '" target="_blank">Menu</a></div>';
			
			htmld += '<div>Distance: ' + fs.distance + '</div>';
			if(fs.user != undefined){
				htmld += '<div>Votes: ' + fs.user.length + '</div>';
				htmld += '<div>';
				for(var i = 0; i < fs.user.length; i++){
					htmld += fs.user[i].imgHTML;
				} 
				htmld += '</div>';
			}
			htmld += '<button class="btn" data-fsid="' + fs.id + '">Vote for Me</button>';
			$(markerDiv).html(htmld);
		},
		
		addSearchFs: function(fs){
			this.searchFs[fs.id] = fs;
		},
		
		removeSearchFs: function(fs){
			//this is removed as a group
			this.searchFs = {};
		},
		
		findFs: function(fsid){
			if(this.voteFs.votes[fsid]){
				return this.voteFs.votes[fsid];
			}else{
				return this.searchFs[fsid];
			}
		},
		
		addUser: function(username){
			if(username == '')
				return;
			
			var re = new RegExp("^(fb:)?");
			var usersplit = username.split(re);
			if(usersplit.length > 1)
			{
				//we have a match
				//grab the end piece
				type = usersplit[usersplit.length-2];
				username = usersplit[usersplit.length-1];
			}else{
				type = 'gravatar';
			}
			
			var img;
			if(type && type == 'fb:')
			{
				img = document.createElement('img');
				img.setAttribute('src', 'https://graph.facebook.com/' + username + '/picture?type=square');
			}else if(readCookie('img') != null){
				img = document.createElement('img');
				img.setAttribute('src', readCookie('img'));
			}else{
				emailhash = md5(username.toLowerCase());
				img = document.createElement('img');
				img.setAttribute('src', 'http://www.gravatar.com/avatar/' + emailhash + '?d=retro&s=18');
			}
			
			this.currentUser = new Josh.User(username, img.src);
			socket.addUser(String(username), String(img.src), area);
			
			userhtml = this.currentUser.imgHTML + username + ' : <a href="#">Sign out</a>';
			$(loginDiv).html(userhtml);
			
			//add cookie for use
			createCookie('username', username);
			createCookie('img', img.src);
			socket.getVotes();
		},
		
		removeUser: function(){
			eraseCookie('username');
			eraseCookie('img');
			this.currentUser = null;
			//send message to server?
			$(loginDiv).html('<input id="login" type="text" placeholder="email">');
		},
		
		addActivity: function(user, fsName, fsid){
			var lihtml = '<li>' + user.imgHTML + user.username + ' voted for <a href="#" data-fsid="' + fsid + '">' + fsName + '</li><hr/>';
			
			$(actsUl).append(lihtml);
		},
		
		showVotes: function(){
			var voteArray = [];
			for(var i in this.voteFs.votes){
				voteArray.push([this.voteFs.votes[i].name, this.voteFs.votes[i].user.length, this.voteFs.votes[i].id, this.voteFs.votes[i].user]);
			}
			voteArray.sort(function(a, b){return b[1] - a[1]});
			var lihtml = '';
			for(var i =0; i < voteArray.length; i++){
				lihtml += '<li>' + voteArray[i][1] + ' for <a href="#" data-fsid="' + voteArray[i][2] + '">' + voteArray[i][0] + '</a></li>';
				for(var u=0; u < voteArray[i][3].length; u++){
					lihtml += voteArray[i][3][u].imgHTML;
				}
			}
			
			$(votesUl).html(lihtml);
		},
		
		findRests: function(query){
			console.log(location);
			var url = 'http://localhost:85/test/fs.php?&ll=' + location.coords.latitude + ',' + location.coords.longitude;
			if(query != ''){
				url += '&query=' + encodeURI(query) ;
			}
			var This = this;
			$.getJSON( url , 
			function(data){
				//console.log(data);
				rests = data.response.groups[0].items;
				This.addSearchLayer(rests);
			});
		},
	};
	
})(window.Josh = window.Josh || {},  window.jQuery);


(function(Josh, $){
	Josh.Votes = function(){
		this.votes = {};
	};
	
	Josh.Votes.prototype = {
		addVote: function(vote){
			console.log(map);
			//first check to see if this person has voted already
			var userVote = this.findByUser(vote.user[0].username);
			if(userVote != undefined){
				 //this person voted, now check to see if this is the only vote
				 if(userVote.user.length == 1){
					 //only this person voted for this restaurant delete it
					 //but first take the marker off the map
					 $(this).trigger('removeLayer', userVote.marker);
					 delete userVote;
				 }else{
					 //multiple people voted for it, just remove their vote
					 for(var i=0; i < userVote.user.length; i++){
						 if(userVote.user[i].username == vote.user[0].username){
							 //we found it! Remove only this user
							 var prevVote = userVote.user.splice(i, 1);
							 delete prevVote;
							 //put the vote back in
							 this.votes[userVote.id] = userVote;
						 }
					 }
				 }
			}
			
			//now check to see if the restaurant exists
			var restVote = this.findByFs(vote.id);
			if(restVote != undefined){
				//add the user to the user list
				restVote.user.push(vote.user[0]);
				//put the vote back in
				this.votes[restVote.id] = restVote;
			}else{
				//nothing else is true
				//add it to the object
				this.votes[vote.id] = vote;
			}
			
		},
		
		findByUser: function(username){
			for(var i in this.votes){
				for(var u=0; u < this.votes[i].user.length; u++){
					if(this.votes[i].user[u].username == username){
						var retEl = this.votes[i];
						delete this.votes[i];
						return retEl;
					}
				}
			}
		},
		
		findByFs: function(fsid){
			var retEl = this.votes[fsid];
			delete this.votes[fsid];
			return retEl;
		},

	};
})(window.Josh = window.Josh || {},  window.jQuery);

//socket = new Josh.Socket('http://192.168.1.89:8080/users');
//console.log(socket);

window.jQuery(document).ready(function() {
var map;

map = new Josh.Map('map');
});

//socket.getVotes();

//vt = new Josh.Votes();

//socket.addEvent('vote', map);
//$(vt).on('vote', function(e, d){ console.log(d);});

 //users = io.connect('http://192.168.1.89:8080/users');
 /*
users.on('users', function(d){
	console.log(d);
	myusername = readCookie('username');
	if(myusername == d.username){
		d.me = true;
	}
	usersul = $('#users');
	console.log(usersul.children('li[data-user="' + d.username + '"]').length);
	if(d.me){
		$('#me').html('<img src="' + d.img + '"/>' + d.username);
		return;
	}
	if(usersul.children('li[data-user="' + d.username + '"]' ).length == 0){
		if(d.me){lic = '<li class="me" ';}else{lic='<li ';}
		usersul.append( lic + 'data-user="' + d.username + '"><img src="' + d.img + '"/>' + d.username+'</li>');
	}else{
		if(d.me){
			usersul.children('li[data-user="' + d.username + '"]' ).addClass('me');
		}
	}
});*/

//users.emit('getVotes');
//users.emit('count');
//users.emit('get');
//socket.getUsers();

/*
function restUser(username, type){
	this.username = username;
	this.type;
	this.view = null;
	this.img = null;
	this.init = function(){
		this.setImg();
	}
	
	this.setImg = function(){
		var img;
		if(type == 'fb:')
		{
			img = document.createElement('img');
			img.setAttribute('src', 'https://graph.facebook.com/' + this.username + '/picture?type=square');
		}else{
			emailhash = md5(this.username.toLowerCase());
			img = document.createElement('img');
			img.setAttribute('src', 'http://www.gravatar.com/avatar/' + emailhash + '?d=mm&s=18');
		}
		this.img = img;
	}
	
	this.render = function(){
		if(this.view){
			return this.view;
		}else{
			wrapper = document.createElement('div');
			namediv = document.createElement('div');
			namediv.innerText = username;
			console.log(namediv);
			$(wrapper).append([namediv, this.img]);
			
			this.view = wrapper;
			return wrapper;
		}
	};
	
	this.init();
}

$("#signin").on("click", function(e){
	e.preventDefault();
	username = $(this).siblings('input').val();
	console.log(username);
	/*var re = new RegExp("^(fb:)?");
	var usersplit = username.split(re);
	console.log(usersplit);
	if(usersplit.length > 1)
	{
		//we have a match
		//grab the end piece
		usertype = usersplit[usersplit.length-2];
		fbuser = usersplit[usersplit.length-1];
		console.log(usertype);
		console.log(fbuser);
		var user = new restUser(fbuser, usertype);
		console.log(user.render());
		//$("#usertest").html(user.render());
		
	}else{
		user = new restUser(username);
		//$("#usertest").html(user.render());
	}
	testu = String(user.username);
	testi = String(user.img.src);
	//users.emit('add', testu, testi);
	socket.addUser(testu, testi);*//*
	map.addUser(username);
	document.cookie = 'username=' + user.username;
	document.cookie = 'img=' + user.img.src;
});*/

//navigator.geolocation.getCurrentPosition(function(location){locSuccess(location)},locError,{timeout:10000});

//fake gelocation point
/*
var locationTest = {
		coords: {
			longitude: -86.2423926,
			latitude: 41.6465882
		}
}*/

/*var locSuccess = function(location){
	console.log(location);
	map.centerLoc(location);
};*/


var locError = function(error){};



//fake call to use the point
//locSuccess(locationTest);

//$('#search').on('focusout', function(e){getRests($(this).val())});

/*
function getRests(query){
	//url = 'http://192.168.1.89/aaron/nodetest/fs.php?callback=?&ll=' + locationTest.coords.latitude + ',' + locationTest.coords.longitude;
	url = 'http://localhost:85/test/fs.php?&ll=' + locationTest.coords.latitude + ',' + locationTest.coords.longitude;
	if(query != ''){
		url += '&query=' + encodeURI(query) ;
	}
$.getJSON( url , 
function(data){
	eats = {};
	//console.log(data);
	rests = data.response.groups[0].items;
	map.addSearchLayer(rests);
});
}*/


//$('#map').on('click', function(e){console.log(e);});


</script>
</div>
</body>
</html>