(function(a){"use strict";a.Cookie={};a.Cookie.createCookie=function(a,b,c){var d;if(c){var e=new Date;e.setTime(e.getTime()+c*24*60*60*1e3);d="; expires="+e.toGMTString()}else{d=""}document.cookie=a+"="+b+d+"; path=/"};a.Cookie.readCookie=function(a){var b=a+"=";var c=document.cookie.split(";");for(var d=0;d<c.length;d++){var e=c[d];while(e.charAt(0)===" "){e=e.substring(1,e.length)}if(e.indexOf(b)===0){return e.substring(b.length,e.length)}}return null};a.Cookie.eraseCookie=function(b){a.Cookie.createCookie(b,"",-1)}})(window.Josh=window.Josh||{});(function(a,b){"use strict";var c;var d;a.Socket=function(a){e(a)};var e=function(a){c=io.connect(a)};a.Socket.prototype.addEvent=function(a,d){c.on(a,function(c){b(d).trigger(a,c)})};a.Socket.prototype.getVotes=function(){c.emit("getVotes")};a.Socket.prototype.getUsers=function(){c.emit("get")};a.Socket.prototype.addUser=function(a,b,d){console.log(a+" "+b);c.emit("add",a,b,d)};a.Socket.prototype.addVote=function(a){var d=b.extend(true,{},a);delete d.marker,d.user;console.log(a);console.log(d);c.emit("addVote",d)};return a.Socket})(window.Josh=window.Josh||{},window.jQuery);(function(a,b){"use strict";a.User=function(a,b){this.username=a;this.img=b;this.imgHTML='<img src="'+b+'" class="userimg" title="'+a+'">'}})(window.Josh=window.Josh||{},window.jQuery);(function(a,b){"use strict";var c;var d;var e;var f;var g;var h;var i;var j;var k;var l;var m;var n;var o;var p;a.Map=function(c){c=c;o=new a.Socket("http://ejosh.co:8080/users");this.map=new L.Map(c);console.log(this.map);var d="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";var q="Map data © openstreetmap contributors";var r=new L.TileLayer(d,{minZoom:8,maxZoom:18,attribution:q});this.map.addLayer(r);e=L.Icon.extend({shadowUrl:null,iconSize:new L.Point(32,32)});f=document.getElementById("fsRest");h=document.getElementById("acts");g=document.getElementById("votes");i=document.getElementById("loginArea");j=document.getElementById("search");k=b("#searchText");l=document.getElementById("clear");m=b("#title");p=b("#alert");var s=this;navigator.geolocation.getCurrentPosition(function(a){s.centerLoc(a)},locError,{timeout:1e4});b(f).on("click","button",function(a){var c=b(a.target);if(s.currentUser!==null){var d=c.attr("data-fsid");var e=s.findFs(d);o.addVote(e);console.log(s.findFs(d))}else{s.addAlert("You must be logged in!")}});b(g).on("click","li a",function(a){a.preventDefault();s.showRest(b(a.target).attr("data-fsid"))});b(h).on("click","li a",function(a){a.preventDefault();s.showRest(b(a.target).attr("data-fsid"))});b(i).on("focusout","input",function(a){var c=b(a.target).val();s.addUser(c)});b(i).on("click","a",function(a){a.preventDefault();s.removeUser()});b(j).on("click",function(a){s.addAlert("Searching for Restaurants");a.preventDefault();s.findRests(k.val());s.removeAlert()});b(l).on("click",function(a){a.preventDefault();k.val("");s.addSearchLayer({})});p.on("click",function(a){s.removeAlert()});this.searchFs={};this.voteFs=new a.Votes;this.currentUser=null;this.searchLayer=null;this.location=null;o.addEvent("vote",this);b(this).on("vote",function(b,c){console.log(this);if(this.voteFs.votes[c.fs.id]===undefined){var d=this.addMarker(c.fs);c.fs.marker=d}c.fs.user=[new a.User(c.username,c.img)];this.addActivity(c.fs.user[0],c.fs.name,c.fs.id);this.voteFs.addVote(c.fs);this.showVotes();console.log(c)});b(this.voteFs).on("removeLayer",function(a,b){s.removeLayer(b)});window.addEventListener("hashchange",function(){window.location.reload()});if(window.location.hash){n=String(window.location.hash).slice(1);m.html(n)}else{n="default"}var t=a.Cookie.readCookie("username");if(t!==null){this.addUser(t)}console.log(this);console.log(this.map instanceof L.Map)};a.Map.prototype={centerLoc:function(a){this.location=a;var b=new L.LatLng(this.location.coords.latitude,this.location.coords.longitude);this.map.setView(b,11)},addMarker:function(a,b){b=typeof b!=="undefined"?b:true;var c;if(a.categories.length>0){c=new e(a.categories[0].icon)}else{c=new L.Icon("images/marker.png")}var d=new L.LatLng(a.location.lat,a.location.lng);var f=new L.Marker(d,{icon:c,title:a.name});f.fsid=a.id;f.img=c.iconUrl;var g=this;f.on("click",function(a){g.showRest(a.target.fsid)});if(b){this.map.addLayer(f)}return f},removeLayer:function(a){this.map.removeLayer(a)},addSearchLayer:function(a){if(this.searchLayer!==null){this.map.removeLayer(this.searchLayer)}this.searchLayer=new L.LayerGroup;for(var b in a){this.addSearchFs(a[b]);var c=this.addMarker(a[b],false);this.searchLayer.addLayer(c)}this.map.addLayer(this.searchLayer);console.log(this)},showRest:function(a){var c=this.findFs(a);var d;if(c.categories.length>0){d=c.categories[0].icon}else{d="images/marker.png"}var e='<h3><img src="'+d+'">'+c.name+"</h3>";if(c.phone!==undefined){e+="<div>Phone: "+c.phone+"</div>"}if(c.menu!==undefined){e+='<div><a href="'+c.menu.url+'" target="_blank">Menu</a></div>'}if(c.user!==undefined){e+="<div>Votes: "+c.user.length+"</div>";e+="<div>";for(var g=0;g<c.user.length;g++){e+=c.user[g].imgHTML}e+="</div>"}e+='<button class="btn" data-fsid="'+c.id+'">Vote for Me</button>';b(f).html(e)},addSearchFs:function(a){this.searchFs[a.id]=a},removeSearchFs:function(a){this.searchFs={}},findFs:function(a){if(this.voteFs.votes[a]){return this.voteFs.votes[a]}else{return this.searchFs[a]}},addUser:function(c){if(c==="")return;var d=new RegExp("^(fb:)?");var e=c.split(d);var f;if(e.length>1){f=e[e.length-2];c=e[e.length-1]}else{f="gravatar"}var g;if(f&&f==="fb:"){g=document.createElement("img");g.setAttribute("src","https://graph.facebook.com/"+c+"/picture?type=square")}else if(a.Cookie.readCookie("img")!==null){g=document.createElement("img");g.setAttribute("src",a.Cookie.readCookie("img"))}else{var h=md5(c.toLowerCase());g=document.createElement("img");g.setAttribute("src","http://www.gravatar.com/avatar/"+h+"?d=retro&s=18")}this.currentUser=new a.User(c,g.src);o.addUser(String(c),String(g.src),n);var j=this.currentUser.imgHTML+c+' : <a href="#">Sign out</a>';b(i).html(j);a.Cookie.createCookie("username",c);a.Cookie.createCookie("img",g.src);o.getVotes()},removeUser:function(){a.Cookie.eraseCookie("username");a.Cookie.eraseCookie("img");this.currentUser=null;b(i).html('<input id="login" type="text" placeholder="email">')},addActivity:function(a,c,d){var e="<li>"+a.imgHTML+a.username+' voted for <a href="#" data-fsid="'+d+'">'+c+"</li><hr/>";b(h).append(e)},showVotes:function(){var a=[];for(var c in this.voteFs.votes){a.push([this.voteFs.votes[c].name,this.voteFs.votes[c].user.length,this.voteFs.votes[c].id,this.voteFs.votes[c].user])}a.sort(function(a,b){return b[1]-a[1]});var d="";for(var e=0;e<a.length;e++){d+="<li>"+a[e][1]+' for <a href="#" data-fsid="'+a[e][2]+'">'+a[e][0]+"</a></li>";for(var f=0;f<a[e][3].length;f++){d+=a[e][3][f].imgHTML}}b(g).html(d)},findRests:function(a){console.log(this.location);var c="https://api.foursquare.com/v2/venues/search?ll="+this.location.coords.latitude+","+this.location.coords.longitude+"&client_id=NQNF2JL2VKJHXETAOND5TPJ23A2SWGZC4TXJEMLGJBXYMIJM&client_secret=TF1CC0HZVBJ0TM50CRNJNTWSOWZMIKQ30V4DEB4GC2UWZ3KM";if(a!==""){c+="&query="+encodeURI(a)}else{c+="&query="+encodeURI("restaurant")}var d=this;console.log(c);b.getJSON(c,function(a){console.log(a);var b=a.response.groups[0].items;d.addSearchLayer(b)})},addAlert:function(a){p.removeClass("none");p.html(a)},removeAlert:function(){p.addClass("none")}}})(window.Josh=window.Josh||{},window.jQuery);(function(a,b){"use strict";a.Votes=function(){this.votes={}};a.Votes.prototype={addVote:function(a){var c=this.findByUser(a.user[0].username);if(c!==undefined){if(c.user.length===1){if(a.marker===undefined){a.marker=c.marker}if(a.id!==c.id){b(this).trigger("removeLayer",c.marker)}}else{for(var d=0;d<c.user.length;d++){if(c.user[d].username===a.user[0].username){var e=c.user.splice(d,1);this.votes[c.id]=c}}}}var f=this.findByFs(a.id);if(f!==undefined){f.user.push(a.user[0]);this.votes[f.id]=f}else{this.votes[a.id]=a}},findByUser:function(a){for(var b in this.votes){for(var c=0;c<this.votes[b].user.length;c++){if(this.votes[b].user[c].username===a){var d=this.votes[b];delete this.votes[b];return d}}}},findByFs:function(a){var b=this.votes[a];delete this.votes[a];return b}}})(window.Josh=window.Josh||{},window.jQuery);var locError=function(a){}